import React, { useMemo, useState, useEffect } from "react";
import { PageWrap, HeaderBar } from "../components/Layout.jsx";
import Btn from "../components/Btn.jsx";
import { THEME_COLORS } from "../components/Chart.jsx";
import OccupationScales from "../components/OccupationScales.jsx";
import ResultsMatches from "./results/ResultsMatches.jsx";
import RiasecHeroSection from "./results/components/RiasecHeroSection.jsx";
import PillarSummaryCards from "./results/components/PillarSummaryCards.jsx";
import CandidateDetailsCard from "./results/components/CandidateDetailsCard.jsx";
import { Q_UNIFIED as Q, RIASEC_SCALE_MAX } from "../questionBank.js";
import { supabase } from "../lib/supabase.js";
import { loadOccupations, pickByPrimaryLetter } from "../lib/occupations.js";

const THEME_NAME = {
  E: "ENTERPRISING",
  A: "ARTISTIC",
  R: "REALISTIC",
  I: "INVESTIGATIVE",
  S: "SOCIAL",
  C: "CONVENTIONAL",
};
const PILLAR_INSIGHTS = {
  DISC: {
    title: "DISC Insights",
    summary:
      "D = Drive (Dominance), I = Influence, S = Steadiness, C = Compliance. Higher bars show which style you lean on when collaboratingâ€”lean into your strongest letter during presentations, group projects, and conflict resolution.",
  },
  "Bloom's Taxonomy": {
    title: "Bloom's Insights",
    summary:
      "These levels reflect the cognitive depth you use most. If analysis/evaluation ranks highest, seek classes that let you synthesize information before presenting.",
  },
  "UN Sustainable Development Goals": {
    title: "SDG Insights",
    summary:
      "This highlights which global challenges resonate most. Use your top SDG to guide service projects, essays, or capstone ideas so your work feels meaningful.",
  },
};
const INTEREST_CONTEXT = {
  R: {
    uni: "Choose lab-heavy science, engineering, or technical electives so you keep building with tools.",
    real: "Volunteer for maker events or maintenance projects to keep your hands-on strengths sharp.",
  },
  I: {
    uni: "Join research assistantships or analytics clubs to feed your curiosity.",
    real: "Sign up for hackathons or citizen-science projects to investigate real problems.",
  },
  A: {
    uni: "Balance theory courses with studio/performance electives and leave each term with new portfolio pieces.",
    real: "Enter design or storytelling competitions to iterate quickly with real briefs.",
  },
  S: {
    uni: "Take service-learning or peer-mentoring classes to practice facilitation.",
    real: "Coach, tutor, or mentor weekly so you stay energized by helping others.",
  },
  E: {
    uni: "Join entrepreneurship clubs, case competitions, or student government to sharpen persuasion.",
    real: "Lead fundraising drives or community campaigns to rally teams around bold targets.",
  },
  C: {
    uni: "Pick electives in accounting, operations, or data management to refine accuracy.",
    real: "Manage budgets or logistics for clubs so others rely on your organization.",
  },
};

function colorForPct(pct) {
  const p = Math.max(0, Math.min(100, Number(pct || 0)));
  if (p < 20) return "#ef4444";
  if (p < 40) return "#f97316";
  if (p < 60) return "#facc15";
  if (p < 80) return "#84cc16";
  return "#22c55e";
}

function levelFromPct(p) {
  if (p >= 75) return "Very High";
  if (p >= 55) return "High";
  if (p >= 40) return "Moderate";
  return "Little";
}

function BarRow({ label, percent, color = "#2563eb" }) {
  return (
    <div className="avoid-break" style={{ marginBottom: 10 }}>
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          fontSize: 13,
          color: "#374151",
          marginBottom: 4,
        }}
      >
        <span>{label}</span>
        <span>{Math.round(percent)}%</span>
      </div>
      <div
        style={{
          height: 10,
          background: "#f3f4f6",
          borderRadius: 6,
          overflow: "hidden",
          border: "1px solid #e5e7eb",
        }}
      >
        <div
          style={{
            width: `${Math.max(0, Math.min(100, percent))}%`,
            height: "100%",
            background: color,
          }}
        />
      </div>
    </div>
  );
}

function ListBox({ title, items }) {
  return (
    <div className="card avoid-break" style={{ padding: 16 }}>
      <h4 style={{ margin: 0, color: "#111827" }}>{title}</h4>
      <ol style={{ margin: "8px 0 0", paddingLeft: 18, color: "#374151" }}>
        {items.map((it, i) => (
          <li key={i} style={{ margin: "4px 0" }}>
            <span style={{ fontWeight: 600 }}>{it.area}</span>{" "}
            <span style={{ color: "#6b7280" }}>({Math.round(it.percent)}%)</span>
          </li>
        ))}
      </ol>
    </div>
  );
}

/* ---------------------- Pillar helpers (percentages) ---------------------- */
function buildBankDenominators() {
  const discCount = { D: 0, I: 0, S: 0, C: 0 };
  const bloomCount = {};
  const sdgCount = {};
  for (const q of Q || []) {
    if (q?.DISC && discCount[q.DISC] != null) discCount[q.DISC] += 1;
    if (q?.BLOOM) bloomCount[q.BLOOM] = (bloomCount[q.BLOOM] || 0) + 1;
    if (q?.UN_Goal) sdgCount[q.UN_Goal] = (sdgCount[q.UN_Goal] || 0) + 1;
  }
  return { discCount, bloomCount, sdgCount };
}

function pctRowsFromTotals(totals, counts) {
  const out = [];
  for (const [label, sum] of Object.entries(totals || {})) {
    const count = counts?.[label] || 0;
    const max = count * RIASEC_SCALE_MAX;
    const pct = max > 0 ? Math.round((Number(sum || 0) / max) * 100) : 0;
    out.push([label, pct]);
  }
  out.sort((a, b) => b[1] - a[1]);
  return out;
}

export default function Results({
  radarData = [],          // [{ code, score }]
  areaPercents = [],       // [{ area, code, percent }]
  interestPercents = [],   // (optional)
  onNavigate,
  participant,
  showParticipantHeader = false,
  fromAdmin = false,
  submission,
  pillarAgg,
  pillarCounts,
}) {
  // If an admin passed a 'submission' record, derive props from it
  if (submission) {
    radarData = submission.radar_data || radarData;
    areaPercents = submission.area_percents || areaPercents;
    participant = submission.participant || submission.profile || participant;
    pillarAgg = submission.pillar_agg || pillarAgg;
    pillarCounts = submission.pillar_counts || pillarCounts;
    fromAdmin = true;
  }
  // Get selected sections from localStorage
  const selectedSections = useMemo(() => {
    try {
      const stored = localStorage.getItem("selectedResultsSections");
      return stored ? JSON.parse(stored) : {
        riasec: true,
        areas: true,
        scales: true,
        occupations: true,
        pillars: true,
      };
    } catch {
      return {
        riasec: true,
        areas: true,
        scales: true,
        occupations: true,
        pillars: true,
      };
    }
  }, []);
  // Map of theme code to score
  const radarByCode = useMemo(() => {
    const m = {};
    (radarData || []).forEach((d) => (m[d.code] = d.score ?? 0));
    return m;
  }, [radarData]);

  const themeOrder = useMemo(
    () => [...(radarData || [])].sort((a, b) => b.score - a.score).map((d) => d.code),
    [radarData]
  );

  const groupedAreas = useMemo(() => {
    const g = {};
    (areaPercents || []).forEach((area) => {
      if (!g[area.code]) g[area.code] = [];
      g[area.code].push(area);
    });
    Object.keys(g).forEach((key) => g[key].sort((a, b) => b.percent - a.percent));
    return g;
  }, [areaPercents]);

  const interestInsights = useMemo(() => {
    const map = {};
    Object.keys(groupedAreas).forEach((code) => {
      const areas = groupedAreas[code] || [];
      if (!areas.length) {
        map[code] = {
          title: `${THEME_NAME[code] || code} Insights`,
          summary: "No responses recorded for this theme yet.",
          uni: INTEREST_CONTEXT[code]?.uni,
          real: INTEREST_CONTEXT[code]?.real,
        };
        return;
      }
      const topArea = areas[0]?.area;
      const runners = areas.slice(1, 3).map((item) => item.area).filter(Boolean);
      const summary =
        runners.length > 0
          ? `Strongest pull: ${topArea}. You also lean toward ${runners.join(" and ")}.`
          : `Strongest pull: ${topArea}. Lean into it with weekly reps.`;
      map[code] = {
        title: `${THEME_NAME[code] || code} Insights`,
        summary,
        uni: INTEREST_CONTEXT[code]?.uni,
        real: INTEREST_CONTEXT[code]?.real,
      };
    });
    return map;
  }, [groupedAreas]);

  const sortedAllAreas = useMemo(
    () => [...(areaPercents || [])].sort((a, b) => b.percent - a.percent),
    [areaPercents]
  );
  const topFive = sortedAllAreas.slice(0, 5);
  const leastThree = sortedAllAreas.slice(-3).reverse();
  const dash = "\u2014";
  const normalizeValue = (value) => {
    if (value == null) return null;
    if (typeof value === "number") return String(value);
    if (typeof value === "string") {
      const trimmed = value.trim();
      return trimmed.length ? trimmed : null;
    }
    return null;
  };
  const displayValue = (...values) => {
    for (const candidate of values) {
      const normalized = normalizeValue(candidate);
      if (normalized) return normalized;
    }
    return dash;
  };
  const candidateName = displayValue(participant?.name, participant?.fullName, participant?.email);
  const schoolValue = displayValue(participant?.school);
  const classValue = displayValue(
    participant?.className,
    participant?.class,
    participant?.grade,
    participant?.section,
    participant?.classroom
  );
  const phoneValue = displayValue(participant?.phone, participant?.tel, participant?.phoneNumber);
  const detailRows = useMemo(
    () => [
      { label: "Name", value: candidateName },
      { label: "School", value: schoolValue },
      { label: "Class", value: classValue },
      { label: "Phone", value: phoneValue },
    ],
    [candidateName, schoolValue, classValue, phoneValue]
  );
  const shouldShowParticipantCard =
    showParticipantHeader || detailRows.some((row) => row.value && row.value !== dash);
  const interestChunks = useMemo(() => {
    const groups = [];
    for (let i = 0; i < themeOrder.length; i += 3) {
      groups.push(themeOrder.slice(i, i + 3));
    }
    return groups;
  }, [themeOrder]);

  /* ---------------------- Load pillars & counts (partial-safe) ---------------------- */
  const { totals, counts } = useMemo(() => {
    if (pillarAgg || pillarCounts) {
      return {
        totals: pillarAgg || { disc: {}, bloom: {}, sdg: {} },
        counts: pillarCounts || { discCount: {}, bloomCount: {}, sdgCount: {} },
      };
    }
    try {
      const rows = JSON.parse(localStorage.getItem("cg_submissions_v1") || "[]");
      const last = Array.isArray(rows) && rows.length ? rows[rows.length - 1] : null;
      if (last) {
        return {
          totals: last.pillarAgg || { disc: {}, bloom: {}, sdg: {} },
          counts: last.pillarCounts || { discCount: {}, bloomCount: {}, sdgCount: {} },
        };
      }
    } catch {}
    return { totals: { disc: {}, bloom: {}, sdg: {} }, counts: { discCount: {}, bloomCount: {}, sdgCount: {} } };
  }, [pillarAgg, pillarCounts]);

  const bankDenoms = useMemo(() => buildBankDenominators(), []);
  const effectiveCounts = useMemo(() => {
    const useAnswered = (obj) => obj && Object.keys(obj).length > 0;
    return {
      disc: useAnswered(counts.discCount) ? counts.discCount : bankDenoms.discCount,
      bloom: useAnswered(counts.bloomCount) ? counts.bloomCount : bankDenoms.bloomCount,
      sdg: useAnswered(counts.sdgCount) ? counts.sdgCount : bankDenoms.sdgCount,
    };
  }, [counts, bankDenoms]);

  const discPct  = useMemo(() => pctRowsFromTotals(totals.disc,  effectiveCounts.disc),  [totals, effectiveCounts]);
  const bloomPct = useMemo(() => pctRowsFromTotals(totals.bloom, effectiveCounts.bloom), [totals, effectiveCounts]);
  const sdgPct   = useMemo(() => pctRowsFromTotals(totals.sdg,   effectiveCounts.sdg),   [totals, effectiveCounts]);
  const pillarSections = useMemo(() => {
    const description = `% = (your total / (answered * ${RIASEC_SCALE_MAX})) * 100`;
    return [
      {
        title: "DISC",
        data: discPct,
        color: "#6366f1",
        description,
        insight: PILLAR_INSIGHTS["DISC"],
      },
      {
        title: "Bloom's Taxonomy",
        data: bloomPct,
        color: "#06b6d4",
        description,
        insight: PILLAR_INSIGHTS["Bloom's Taxonomy"],
      },
      {
        title: "UN Sustainable Development Goals",
        data: sdgPct,
        color: "#f59e0b",
        description,
        insight: PILLAR_INSIGHTS["UN Sustainable Development Goals"],
      },
    ];
  }, [discPct, bloomPct, sdgPct]);

  /* ---------------------- Print helpers ---------------------- */
  const handlePrint = () => {
    setTimeout(() => window.print(), 150);
  };

  const headerBlock = (
    <>
      <HeaderBar title={fromAdmin ? "Career Guidance Report" : "Results (Admin View)"} />
      <div className="no-print" style={{ display: "flex", justifyContent: "flex-end", gap: 8, margin: "8px 0 12px" }}>
        <Btn variant="secondary" onClick={() => onNavigate(fromAdmin ? "admin-dashboard" : "home")}>
          {fromAdmin ? "Back to Submissions" : "Back Home"}
        </Btn>
        <Btn variant="primary" onClick={handlePrint} title="Export to PDF">
          Export PDF
        </Btn>
      </div>
    </>
  );

  return (
    <PageWrap>
      <style>{`
        .card {
          border: 1px solid #d1d5db;
          border-radius: 16px;
          background: #ffffff;
          margin-bottom: 18px;
        }
        @media print {
          body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
          }
          .no-print {
            display: none !important;
          }
          .candidate-first-page {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: calc(297mm - 40mm);
            page-break-after: always;
            padding-bottom: 24px;
          }
          .candidate-first-page .candidate-card {
            margin-top: auto;
          }
        }
      `}</style>

      {shouldShowParticipantCard ? (
        <div className="candidate-first-page">
          <div className="candidate-title-block">
            <HeaderBar title={fromAdmin ? "Career Guidance Report" : "Results (Admin View)"} />
            <div className="no-print" style={{ display: "flex", justifyContent: "flex-end", gap: 8, margin: "8px 0 12px" }}>
              <Btn variant="secondary" onClick={() => onNavigate(fromAdmin ? "admin-dashboard" : "home")}>
                {fromAdmin ? "Back to Submissions" : "Back Home"}
              </Btn>
              <Btn variant="primary" onClick={handlePrint} title="Export to PDF">
                Export PDF
              </Btn>
            </div>
          </div>
          <CandidateDetailsCard rows={detailRows} />
        </div>
      ) : (
        headerBlock
      )}

      {/* GROUP 3: Basic Interest Scales (theme cards) */}
      {interestChunks.map((group, groupIdx) => (
        <div
          key={`interest-card-${groupIdx}`}
          className="card section"
          style={{
            padding: 16,
            marginTop: groupIdx === 0 ? 0 : 16,
            pageBreakAfter: groupIdx < interestChunks.length - 1 ? "always" : "auto",
          }}
        >
          <h3 style={{ margin: 0, color: "#111827" }}>
            BASIC INTEREST SCALES (Set {groupIdx + 1})
          </h3>
          <p style={{ marginTop: 6, color: "#6b7280", fontSize: 14 }}>
            Percentages across specific interest areas within each RIASEC theme.
          </p>
          <div
            style={{
              display: "grid",
              gridTemplateColumns: "1fr",
              gap: 16,
              marginTop: 8,
            }}
          >
            {group.map((code) => {
              const themeScore = radarByCode[code] ?? 0;
              const level = levelFromPct(themeScore);
              const areas = groupedAreas[code] || [];
              const color = THEME_COLORS[code] || "#2563eb";
              const insight = interestInsights[code] || {};
              return (
                <div
                  key={code}
                  className="card avoid-break"
                style={{ padding: 16, background: "#ffffff" }}
              >
                <div
                  style={{
                    display: "flex",
                    gap: 12,
                    alignItems: "stretch",
                    flexWrap: "nowrap",
                  }}
                >
                  <div
                    style={{
                      flex: "2 1 340px",
                      minWidth: 280,
                      display: "flex",
                      flexDirection: "column",
                      gap: 12,
                    }}
                  >
                    <div
                      style={{
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "baseline",
                        gap: 12,
                      }}
                      className="avoid-break"
                    >
                      <h4 style={{ margin: 0, color: "#111827" }}>
                        {THEME_NAME[code]}{" "}
                        <span style={{ fontWeight: 400, color: "#6b7280", fontSize: 14 }}>
                          Level: {level}
                        </span>
                      </h4>
                      <span
                        aria-hidden
                        style={{
                          width: 14,
                          height: 14,
                          borderRadius: 3,
                          background: color,
                          display: "inline-block",
                        }}
                      />
                    </div>

                    <div>
                      {areas.length ? (
                        areas.map((a) => (
                          <BarRow
                            key={`${code}-${a.area}`}
                            label={a.area}
                            percent={a.percent}
                            color={color}
                          />
                        ))
                      ) : (
                        <div style={{ color: "#6b7280", fontSize: 13 }}>
                          No answers recorded for this theme.
                        </div>
                      )}
                    </div>
                  </div>

                  <aside
                    style={{
                      border: "1px solid #e5e7eb",
                      borderRadius: 10,
                      padding: 12,
                      background: "#f8fafc",
                      color: "#475569",
                      fontSize: 13,
                      flex: "1 1 220px",
                      minWidth: 220,
                      display: "flex",
                      flexDirection: "column",
                      gap: 6,
                    }}
                  >
                    <div style={{ fontWeight: 600, color: "#111827" }}>
                      {insight.title || `${THEME_NAME[code] || code} Insights`}
                    </div>
                    <p style={{ margin: 0, lineHeight: 1.4 }}>{insight.summary || "Lean into this area with weekly practice to confirm the fit."}</p>
                    {insight.uni && (
                      <p style={{ margin: 0, lineHeight: 1.4 }}>
                        <strong>University focus:</strong> {insight.uni}
                      </p>
                    )}
                    {insight.real && (
                      <p style={{ margin: 0, lineHeight: 1.4 }}>
                        <strong>Real-life focus:</strong> {insight.real}
                      </p>
                    )}
                  </aside>
                </div>
              </div>
            );
          })}
        </div>
      ))}

      {/* GROUP 4: Occupational Scales (kept together) */}
      <div className="section avoid-break">
        <OccupationScales radarByCode={radarByCode} themeOrder={themeOrder} />
      </div>

      {/* PAGE BREAK before pillars, for a clean pillar page */}
      <div className="no-print" style={{ height: 1 }} />
      <div
        style={{
          pageBreakBefore: "always",
          breakBefore: "page",
          height: 0,
          overflow: "hidden",
        }}
      />

      {/* GROUP 5: Pillars - three elegant cards */}
      <PillarSummaryCards sections={pillarSections} scaleLabel="Percent of Max" />

      {/* RIASEC overview placed near the end */}
      <div
        style={{
          pageBreakBefore: "always",
          breakBefore: "page",
          height: 0,
          overflow: "hidden",
        }}
      />
      <RiasecHeroSection radarData={radarData} />

      {/* Top & Least Areas now at the end */}
      <div className="section avoid-break">
        <div
          className="print-stack"
          style={{
            display: "grid",
            gridTemplateColumns: "1.3fr 1fr",
            gap: 16,
          }}
        >
          <ListBox title="Your Top Five Interest Areas" items={topFive} />
          <ListBox title="Areas of Least Interest" items={leastThree} />
        </div>
      </div>

      {/* Footer actions (hidden in print) */}
      <div className="no-print" style={{ display: "flex", justifyContent: "flex-end", gap: 8, marginTop: 12 }}>
        <Btn variant="secondary" onClick={() => onNavigate?.(fromAdmin ? "admin-dashboard" : "home")}>
          {fromAdmin ? "Back to Submissions" : "Back Home"}
        </Btn>
        <Btn variant="primary" onClick={handlePrint} title="Export to PDF">
          Export PDF
        </Btn>
      </div>
    </PageWrap>
  );
}






